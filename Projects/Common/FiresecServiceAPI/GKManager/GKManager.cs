using System;
using System.Collections.Generic;
using System.Linq;
using Common;
using FiresecAPI.GK;

namespace FiresecClient
{
	public partial class GKManager
	{
		public static GKDeviceConfiguration DeviceConfiguration { get; set; }
		public static GKDriversConfiguration DriversConfiguration { get; set; }
		public static GKDeviceLibraryConfiguration DeviceLibraryConfiguration { get; set; }

		static GKManager()
		{
			DeviceConfiguration = new GKDeviceConfiguration();
			DriversConfiguration = new GKDriversConfiguration();
			AutoGeneratedDelays = new List<GKDelay>();
			AutoGeneratedPims = new List<GKPim>();
		}

		public static List<GKDevice> Devices
		{
			get { return DeviceConfiguration.Devices; }
		}
		public static List<GKZone> Zones
		{
			get { return DeviceConfiguration.Zones; }
		}
		public static List<GKDirection> Directions
		{
			get { return DeviceConfiguration.Directions; }
		}
		public static List<GKPumpStation> PumpStations
		{
			get { return DeviceConfiguration.PumpStations; }
		}
		public static List<GKMPT> MPTs
		{
			get { return DeviceConfiguration.MPTs; }
		}
		public static List<GKDriver> Drivers
		{
			get { return DriversConfiguration.Drivers; }
		}
		public static List<GKParameterTemplate> ParameterTemplates
		{
			get { return GKManager.DeviceConfiguration.ParameterTemplates; }
		}
		public static List<GKDelay> Delays
		{
			get { return DeviceConfiguration.Delays; }
		}
		public static List<GKGuardZone> GuardZones
		{
			get { return DeviceConfiguration.GuardZones; }
		}
		public static List<GKDoor> Doors
		{
			get { return DeviceConfiguration.Doors; }
		}

		public static List<GKDelay> AutoGeneratedDelays { get; set; }
		public static List<GKPim> AutoGeneratedPims { get; set; }

		public static void SetEmptyConfiguration()
		{
			DeviceConfiguration = new GKDeviceConfiguration();
			var driver = Drivers.FirstOrDefault(x => x.DriverType == GKDriverType.System);
			DeviceConfiguration.RootDevice = new GKDevice()
			{
				DriverUID = driver.UID
			};
			UpdateConfiguration();
		}

		public static void UpdateConfiguration()
		{
			DeviceConfiguration.UpdateConfiguration();
		}

		public static void PrepareDescriptors()
		{
			DeviceConfiguration.PrepareDescriptors();
		}

		public static ushort GetKauLine(GKDevice device)
		{
			ushort lineNo = 0;
			if (device.Driver.IsKauOrRSR2Kau)
			{
				var modeProperty = device.Properties.FirstOrDefault(x => x.Name == "Mode");
				if (modeProperty != null)
				{
					return modeProperty.Value;
				}
			}
			return lineNo;
		}

		public static string GetIpAddress(GKDevice device)
		{
			GKDevice gkControllerDevice = null;
			switch (device.DriverType)
			{
				case GKDriverType.GK:
					gkControllerDevice = device;
					break;

				case GKDriverType.KAU:
				case GKDriverType.RSR2_KAU:
					gkControllerDevice = device.Parent;
					break;

				default:
					{
						Logger.Error("GKManager.GetIpAddress Получить IP адрес можно только у ГК или в КАУ");
						throw new Exception("Получить IP адрес можно только у ГК или в КАУ");
					}
			}
			var ipAddress = gkControllerDevice.GetGKIpAddress();
			return ipAddress;
		}

		public static bool IsManyGK()
		{
			return DeviceConfiguration.Devices.Where(x => x.DriverType == GKDriverType.GK).Count() > 1;
		}
	}
}